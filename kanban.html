<!doctype html>

<html ng-app="taskboardApp">

    <head>
        <title>Kanban for Outlook</title>

        <meta http-equiv="X-UA-Compatible" content="IE=11">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="-1">

        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/kfo.css">
        <link id="kfo-theme-link" rel="stylesheet" href="themes/kfo-light/theme.css">

        <!-- scripts (all local) -->
        <script src="vendor/jquery.min.js"></script>
        <script src="vendor/jquery-ui.min.js"></script>
        <script src="vendor/angular.min.js"></script>
        <script src="vendor/sortable.min.js"></script>
        <script src="vendor/moment.min.js"></script>
        <script src="vendor/minify.json.js"></script>

        <script src="js/version.js"></script>
        <script src="js/exchange.js"></script>
        <script src="js/app.js"></script>
    </head>

    <body ng-controller="taskboardController" ng-init="init()" class="kfo" ng-class="rootClasses">

        <div ng-if="!isBrowserSupported" class="container" style="padding: 18px;">
            <h3>Kanban for Outlook</h3>
            <p>This app is designed to run as a Folder Home Page inside <strong>classic Outlook for Windows</strong> (not the new Outlook).</p>

            <p><strong>Common causes</strong></p>
            <ul>
                <li>You opened <code>kanban.html</code> in a normal browser instead of inside Outlook.</li>
                <li>Your organisation may have disabled Folder Home Pages by policy.</li>
                <li>ActiveX / scripting is blocked for Folder Home Pages.</li>
            </ul>

            <p><strong>Next steps</strong></p>
            <ol>
                <li>Extract this folder to a location you control (for example under your user profile).</li>
                <li>Run <code>install-local.cmd</code> to register the home page for Outlook.</li>
                <li>Restart Outlook.</li>
            </ol>

            <p>
                <a href="docs/SETUP.md">Setup guide</a>
                &nbsp;•&nbsp;
                <a href="docs/TROUBLESHOOTING.md">Troubleshooting</a>
            </p>

            <div class="kfo-small" style="margin-top: 10px;">
                Detected host: <code>{{browserSupport.method}}</code>
                <span ng-if="browserSupport.error">&nbsp;•&nbsp;Error: <code>{{browserSupport.error}}</code></span>
            </div>
            <div class="kfo-small" style="margin-top: 6px;">
                Location: <code>{{env.href}}</code>
            </div>
            <p class="text-muted">No network access is required or used by this application.</p>
        </div>

        <div ng-if="isBrowserSupported" class="kfo-app">
            <header class="kfo-topbar">
                <div class="kfo-brand" ng-click="switchMode('board')" style="cursor:pointer;">
                    <div class="kfo-brandTitle">Kanban for Outlook</div>
                    <div class="kfo-brandMeta">v{{version}}</div>
                </div>

                <div class="kfo-topbarSection">
                    <select class="kfo-select" ng-model="filter.mailbox" ng-options="m for m in mailboxes" ng-change="onMailboxChanged()" ng-if="config.MULTI_MAILBOX"></select>
                    <select class="kfo-select" ng-model="ui.projectEntryID" ng-options="p.entryID as p.name for p in projects" ng-change="onProjectChanged()"></select>
                    <button class="kfo-btn" type="button" ng-click="openCreateProject()">
                        <span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span>
                        <span>Project</span>
                    </button>
                </div>

                <div class="kfo-topbarGrow kfo-search">
                    <span class="glyphicon glyphicon-search kfo-searchIcon" aria-hidden="true"></span>
                    <input class="kfo-input kfo-searchInput" type="text" ng-model="filter.search" placeholder="Search tasks" ng-change="applyFilters()" />
                    <button class="kfo-iconBtn kfo-searchClear" type="button" ng-if="filter.search" ng-click="filter.search=''; applyFilters();" aria-label="Clear search">
                        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                    </button>
                </div>

                <div class="kfo-topbarSection">
                    <select class="kfo-select" ng-model="filter.category" ng-options="c for c in categories" ng-change="applyFilters()"></select>
                    <select class="kfo-select" ng-model="filter.private">
                        <option value="{{privacyFilter.all.value}}">{{privacyFilter.all.text}}</option>
                        <option value="{{privacyFilter.private.value}}">{{privacyFilter.private.text}}</option>
                        <option value="{{privacyFilter.public.value}}">{{privacyFilter.public.text}}</option>
                    </select>

                    <button class="kfo-iconBtn" type="button" ng-click="refreshTasks()" aria-label="Refresh" ng-class="{'kfo-refreshing': ui.isRefreshing}">
                        <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
                    </button>
                    <button class="kfo-iconBtn kfo-iconBtn--danger" type="button" ng-if="ui.lastError" ng-click="openErrorDetails()" aria-label="Error details" title="Error details">
                        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                    </button>
                    <button class="kfo-iconBtn" type="button" ng-click="switchMode('settings')" aria-label="Settings">
                        <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>
                    </button>
                    <button class="kfo-iconBtn" type="button" ng-click="switchMode('help')" aria-label="Help">
                        <span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
                    </button>
                </div>
            </header>

            <main class="kfo-main">
                <section class="kfo-board" ng-if="ui.mode == 'board'">
                    <div class="kfo-lanes">
                        <div class="kfo-lane" ng-repeat="lane in lanes track by lane.id" ng-if="lane.enabled" ng-style="laneContainerStyle(lane, $index)">
                            <div class="kfo-laneHeader" ng-style="laneHeaderStyle(lane)">
                                <div class="kfo-laneHeaderLeft">
                                    <div class="kfo-laneTitle">{{lane.title}}</div>
                                    <div class="kfo-laneSub" ng-if="config.UI.showLaneCounts">
                                        {{lane.filteredTasks.length}} tasks
                                        <span ng-if="lane.wipLimit > 0">&nbsp;•&nbsp;WIP {{lane.wipLimit}}</span>
                                    </div>
                                </div>
                                <div class="kfo-laneHeaderRight">
                                    <span class="kfo-pill" ng-if="lane.wipLimit > 0 && lane.filteredTasks.length > lane.wipLimit">Over limit</span>
                                    <button class="kfo-iconBtn" type="button" ng-click="addTask(lane)" aria-label="Add task">
                                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                                    </button>
                                </div>
                            </div>

                            <ul class="kfo-tasklist kfo-tasklist" ui-sortable="sortableOptions" ng-model="lane.filteredTasks" data-lane-id="{{lane.id}}">
                                <li class="kfo-task" ng-repeat="task in lane.filteredTasks track by task.entryID" ng-dblclick="editTask(task)" ng-class="taskCardClasses(task)" ng-style="taskItemStyle($parent.$index, $index)">
                                    <div class="kfo-taskHeader">
                                        {{task.subject}}
                                    </div>

                                    <div class="kfo-taskMeta">
                                        <div>
                                            <span ng-if="config.UI.showDueDate && task.dueText" class="kfo-due" ng-class="task.dueClass">Due: {{task.dueText}}</span>
                                            <span ng-if="!task.dueText">&nbsp;</span>
                                        </div>
                                        <div>
                                            <span class="glyphicon glyphicon-lock" aria-hidden="true" ng-if="config.UI.showPrivacyIcon && task.sensitivity === 2"></span>
                                            <span ng-if="config.UI.showPriorityPill && task.priority === 2" class="kfo-pill">High</span>
                                        </div>
                                    </div>

                                    <div class="kfo-taskBody" ng-if="config.UI.showNotes && task.notes">{{task.notes}}</div>

                                    <div class="kfo-taskFooter" ng-style="getFooterStyle(task.categories)">
                                        <div class="kfo-taskTags" ng-if="config.UI.showCategories">
                                            <span class="kfo-tag" ng-repeat="cat in visibleCategories(task.categories)" ng-style="cat.style">{{cat.label}}</span>
                                        </div>
                                        <div class="kfo-taskActions">
                                            <button class="kfo-iconBtn" type="button" aria-label="OneNote" ng-if="task.oneNoteURL" ng-click="openOneNoteURL(task.oneNoteURL)">
                                                <span class="glyphicon glyphicon-book" aria-hidden="true"></span>
                                            </button>
                                            <button class="kfo-iconBtn" type="button" aria-label="Edit" ng-click="editTask(task)">
                                                <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                                            </button>
                                            <button class="kfo-iconBtn" type="button" aria-label="Delete" ng-click="deleteTask(task, true)">
                                                <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                                            </button>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </section>

                <section class="kfo-view" ng-if="ui.mode == 'settings'">
                    <div class="kfo-grid">
                        <div class="kfo-gridCol">
                            <div class="kfo-card">
                                <div class="kfo-cardTitle">Projects</div>

                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Projects root</div>
                                    <div class="kfo-rowControl">
                                        <input class="kfo-input" type="text" ng-model="config.PROJECTS.rootFolderName" />
                                        <div class="kfo-small">Projects are Outlook task folders under this root.</div>
                                    </div>
                                </div>

                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Default project</div>
                                    <div class="kfo-rowControl">
                                        <select class="kfo-select" ng-model="config.PROJECTS.defaultProjectEntryID" ng-options="p.entryID as p.name for p in projects"></select>
                                    </div>
                                </div>

                                <div class="kfo-divider"></div>

                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">New project</div>
                                    <div class="kfo-rowControl">
                                        <div class="kfo-row">
                                            <input class="kfo-input" type="text" ng-model="ui.newProjectName" placeholder="Project name" />
                                            <button class="kfo-btn" type="button" ng-click="createProject(ui.newProjectName)">Create</button>
                                            <button class="kfo-btn" type="button" ng-click="openLinkProject()">Link existing</button>
                                        </div>
                                    </div>
                                </div>

                                <div class="kfo-divider"></div>

                                <div class="kfo-small" style="margin-bottom:8px;">Visible projects appear in the header. Hidden projects remain in Outlook.</div>

                                <div class="kfo-list">
                                    <div class="kfo-listItem" ng-repeat="p in projectsAll">
                                        <div class="kfo-listItemMain">
                                            <div class="kfo-listItemTitle">{{p.name}}</div>
                                            <div class="kfo-listItemMeta">
                                                <span class="kfo-pill" ng-if="p.entryID == ui.projectEntryID">Selected</span>
                                                <span class="kfo-pill" ng-if="p.isHidden">Hidden</span>
                                                <span class="kfo-pill" ng-if="p.isLinked">Linked</span>
                                            </div>
                                        </div>
                                        <div class="kfo-listItemActions">
                                            <button class="kfo-btn" type="button" ng-click="selectProject(p.entryID)" ng-disabled="p.entryID == ui.projectEntryID">Select</button>
                                            <button class="kfo-btn" type="button" ng-click="openRenameProject(p)" ng-disabled="p.isDefaultTasks">Rename</button>
                                            <button class="kfo-btn" type="button" ng-click="toggleProjectHidden(p)">{{p.isHidden ? 'Show' : 'Hide'}}</button>
                                            <button class="kfo-btn" type="button" ng-if="p.isLinked" ng-click="unlinkProject(p.entryID)">Unlink</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="kfo-card">
                                <div class="kfo-cardTitle">Appearance</div>

                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Theme</div>
                                    <div class="kfo-rowControl">
                                        <select class="kfo-select" ng-model="config.THEME.activeThemeId" ng-options="t.id as t.name for t in allThemes" ng-change="applyTheme()"></select>
                                        <div class="kfo-small">Themes are local CSS only.</div>
                                    </div>
                                </div>

                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Density</div>
                                    <div class="kfo-rowControl">
                                        <select class="kfo-select" ng-model="config.UI.density" ng-change="applyRootClasses()">
                                            <option value="compact">Compact</option>
                                            <option value="comfortable">Comfortable</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Motion</div>
                                    <div class="kfo-rowControl">
                                        <select class="kfo-select" ng-model="config.UI.motion" ng-change="applyRootClasses()">
                                            <option value="full">Full</option>
                                            <option value="subtle">Subtle</option>
                                            <option value="off">Off</option>
                                        </select>
                                        <div class="kfo-small">Turn motion off if Outlook performance is impacted.</div>
                                    </div>
                                </div>

                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Lane width</div>
                                    <div class="kfo-rowControl">
                                        <input class="kfo-input" type="number" ng-model="config.UI.laneWidthPx" style="max-width:120px;" />
                                        <span class="kfo-small">px (240-520)</span>
                                    </div>
                                </div>

                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Cards</div>
                                    <div class="kfo-rowControl">
                                        <label class="kfo-pill" style="margin:0;">
                                            <input type="checkbox" ng-model="config.UI.showDueDate" />
                                            Due date
                                        </label>
                                        <label class="kfo-pill" style="margin:0;">
                                            <input type="checkbox" ng-model="config.UI.showNotes" />
                                            Notes
                                        </label>
                                        <label class="kfo-pill" style="margin:0;">
                                            <input type="checkbox" ng-model="config.UI.showCategories" />
                                            Categories
                                        </label>
                                        <label class="kfo-pill" style="margin:0;" ng-if="config.UI.showCategories">
                                            <input type="checkbox" ng-model="config.UI.showOnlyFirstCategory" />
                                            First only
                                        </label>
                                        <label class="kfo-pill" style="margin:0;">
                                            <input type="checkbox" ng-model="config.UI.showPriorityPill" />
                                            Priority pill
                                        </label>
                                        <label class="kfo-pill" style="margin:0;">
                                            <input type="checkbox" ng-model="config.UI.showPrivacyIcon" />
                                            Privacy icon
                                        </label>
                                        <label class="kfo-pill" style="margin:0;">
                                            <input type="checkbox" ng-model="config.UI.showLaneCounts" />
                                            Lane counts
                                        </label>
                                    </div>
                                </div>

                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Import theme</div>
                                    <div class="kfo-rowControl">
                                        <input type="file" id="themeCssFile" accept=".css" />
                                        <div class="kfo-row" style="margin-top:8px;">
                                            <input class="kfo-input" type="text" ng-model="ui.importThemeName" placeholder="Theme name" />
                                            <input class="kfo-input" type="text" ng-model="ui.importThemeId" placeholder="Theme id (letters, numbers, -)" />
                                            <button class="kfo-btn" type="button" ng-click="importThemeFromFile()">Import</button>
                                        </div>
                                    </div>
                                </div>

                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Folder theme</div>
                                    <div class="kfo-rowControl">
                                        <div class="kfo-row">
                                            <input class="kfo-input" type="text" ng-model="ui.folderThemeName" placeholder="Theme name" />
                                            <input class="kfo-input" type="text" ng-model="ui.folderThemeId" placeholder="Theme id" />
                                        </div>
                                        <div class="kfo-row">
                                            <input class="kfo-input" type="text" ng-model="ui.folderThemeHref" placeholder="CSS path (e.g. themes/my-theme/theme.css)" />
                                            <button class="kfo-btn" type="button" ng-click="addFolderTheme()">Add</button>
                                        </div>
                                        <div class="kfo-small">Use the skeleton in <code>themes/skeleton/</code> to create your own.</div>
                                    </div>
                                </div>
                            </div>

                            <div class="kfo-card">
                                <div class="kfo-cardTitle">Board</div>

                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Ordering</div>
                                    <div class="kfo-rowControl">
                                        <label class="kfo-pill" style="margin:0;">
                                            <input type="checkbox" ng-model="config.BOARD.saveOrder" />
                                            Manual order (drag)
                                        </label>
                                        <div class="kfo-small">Stores order per lane on each task.</div>
                                    </div>
                                </div>

                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Remember</div>
                                    <div class="kfo-rowControl">
                                        <label class="kfo-pill" style="margin:0;">
                                            <input type="checkbox" ng-model="config.BOARD.saveState" />
                                            Filters and project
                                        </label>
                                    </div>
                                </div>

                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Notes length</div>
                                    <div class="kfo-rowControl">
                                        <input class="kfo-input" type="number" ng-model="config.BOARD.taskNoteMaxLen" style="max-width:120px;" />
                                        <span class="kfo-small">characters</span>
                                    </div>
                                </div>

                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Date format</div>
                                    <div class="kfo-rowControl">
                                        <select class="kfo-select" ng-model="config.DATE_FORMAT">
                                            <option value="DD-MMM">DD-MMM</option>
                                            <option value="D MMM">D MMM</option>
                                            <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                            <option value="DD/MM">DD/MM</option>
                                            <option value="MM/DD">MM/DD</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Categories</div>
                                    <div class="kfo-rowControl">
                                        <label class="kfo-pill" style="margin:0;">
                                            <input type="checkbox" ng-model="config.USE_CATEGORY_COLORS" />
                                            Color tags
                                        </label>
                                        <label class="kfo-pill" style="margin:0;" ng-if="config.USE_CATEGORY_COLORS">
                                            <input type="checkbox" ng-model="config.USE_CATEGORY_COLOR_FOOTERS" />
                                            Color footer
                                        </label>
                                    </div>
                                </div>

                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Diagnostics</div>
                                    <div class="kfo-rowControl">
                                        <label class="kfo-pill" style="margin:0;">
                                            <input type="checkbox" ng-model="config.LOG_ERRORS" />
                                            Debug logging
                                        </label>
                                        <div class="kfo-small">Keeps a local error log in Outlook.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="kfo-gridCol">
                            <div class="kfo-card">
                                <div class="kfo-cardTitle">Lanes</div>

                                <div class="kfo-row" ng-repeat="lane in config.LANES">
                                    <div class="kfo-rowLabel">Lane</div>
                                    <div class="kfo-rowControl">
                                        <div class="kfo-row">
                                            <input class="kfo-input" type="text" ng-model="lane.title" placeholder="Title" />
                                            <input class="kfo-input" type="text" ng-model="lane.id" placeholder="Id" />
                                            <input class="kfo-input" type="text" ng-model="lane.color" placeholder="#RRGGBB" />
                                            <input class="kfo-input" type="number" ng-model="lane.wipLimit" placeholder="WIP" style="max-width:90px;" />
                                            <select class="kfo-select" ng-model="lane.outlookStatus" title="Optional: sync Outlook Status">
                                                <option ng-value="null">No status sync</option>
                                                <option ng-value="0">Not Started</option>
                                                <option ng-value="1">In Progress</option>
                                                <option ng-value="3">Waiting</option>
                                                <option ng-value="4">Deferred</option>
                                                <option ng-value="2">Completed</option>
                                            </select>
                                            <label class="kfo-pill" style="margin:0;">
                                                <input type="checkbox" ng-model="lane.enabled" />
                                                Enabled
                                            </label>
                                            <button class="kfo-btn" type="button" ng-click="moveLaneUp($index)">Up</button>
                                            <button class="kfo-btn" type="button" ng-click="moveLaneDown($index)">Down</button>
                                            <button class="kfo-btn" type="button" ng-click="removeLane($index)">Remove</button>
                                        </div>
                                    </div>
                                </div>

                                <div class="kfo-divider"></div>

                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">New lane</div>
                                    <div class="kfo-rowControl">
                                        <div class="kfo-row">
                                            <input class="kfo-input" type="text" ng-model="ui.newLaneTitle" placeholder="Title" />
                                            <input class="kfo-input" type="text" ng-model="ui.newLaneId" placeholder="Id" />
                                            <input class="kfo-input" type="text" ng-model="ui.newLaneColor" placeholder="#RRGGBB" />
                                            <button class="kfo-btn" type="button" ng-click="addLane()">Add</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="kfo-card">
                                <div class="kfo-cardTitle">Tools</div>
                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Automation</div>
                                    <div class="kfo-rowControl">
                                        <label class="kfo-pill" style="margin:0;">
                                            <input type="checkbox" ng-model="config.AUTOMATION.setOutlookStatusOnLaneMove" />
                                            Sync Outlook status on move
                                        </label>
                                        <div class="kfo-small">If enabled, lanes with a status mapping will update the Outlook task Status on drag/drop.</div>
                                    </div>
                                </div>
                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Migration</div>
                                    <div class="kfo-rowControl">
                                        <button class="kfo-btn" type="button" ng-click="openMigration()">Migrate lanes</button>
                                        <div class="kfo-small">Bulk-assign lanes for tasks in the current project (local-only).</div>
                                    </div>
                                </div>
                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Move tasks</div>
                                    <div class="kfo-rowControl">
                                        <button class="kfo-btn" type="button" ng-click="openMoveTasks()">Move between projects</button>
                                        <div class="kfo-small">Moves tasks between Outlook folders while keeping lane metadata.</div>
                                    </div>
                                </div>
                            </div>

                            <div class="kfo-card">
                                <div class="kfo-cardTitle">Privacy & Local-Only</div>
                                <p class="kfo-small">This fork is local-only by design: no external downloads, update checks, telemetry, or support email targets.</p>
                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Diagnostics</div>
                                    <div class="kfo-rowControl">
                                        <button class="kfo-btn" type="button" ng-click="openDiagnostics()">View / Export</button>
                                        <div class="kfo-small">Review what would be shared before you share anything.</div>
                                    </div>
                                </div>
                            </div>

                            <div class="kfo-card">
                                <div class="kfo-cardTitle">Save</div>
                                <div class="kfo-row">
                                    <div class="kfo-rowLabel">Actions</div>
                                    <div class="kfo-rowControl">
                                        <button class="kfo-btn" type="button" ng-click="saveAndReturn()">Save settings</button>
                                        <button class="kfo-btn" type="button" ng-click="switchMode('board')">Back to board</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="kfo-view" ng-if="ui.mode == 'help'">
                    <div class="kfo-card">
                        <div class="kfo-cardTitle">Help</div>
                        <p><strong>Local-only</strong>: this app does not require or use network access.</p>
                        <p><strong>Projects</strong> are Outlook task folders. <strong>Lanes</strong> are stored on each task using a custom property.</p>
                        <p class="kfo-small">Maintainer: Iman Sharif. Credits: see ACKNOWLEDGEMENTS in the repository.</p>
                        <p class="kfo-small">Disclaimer: this software is provided "AS IS" with no warranty.</p>
                        <div class="kfo-divider"></div>
                        <button class="kfo-btn" type="button" ng-click="switchMode('board')">Back to board</button>
                    </div>
                </section>
            </main>

            <!-- Setup wizard (first run / migration) -->
            <div class="kfo-modalBackdrop" ng-if="ui.showSetupWizard">
                <div class="kfo-modal">
                    <div class="kfo-modalHeader">
                        <h3 class="kfo-modalTitle">Welcome to Kanban for Outlook</h3>
                        <button class="kfo-iconBtn" type="button" ng-click="closeSetupWizard()" aria-label="Close">
                            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                        </button>
                    </div>
                    <div class="kfo-modalBody">
                        <div class="kfo-stepper">
                            <span class="kfo-step" ng-class="{'kfo-stepActive': ui.setupStep == 1}">Theme</span>
                            <span class="kfo-step" ng-class="{'kfo-stepActive': ui.setupStep == 2}">Projects</span>
                            <span class="kfo-step" ng-class="{'kfo-stepActive': ui.setupStep == 3}">Lanes</span>
                            <span class="kfo-step" ng-class="{'kfo-stepActive': ui.setupStep == 4}">Finish</span>
                        </div>

                        <div ng-if="ui.setupStep == 1">
                            <p>Pick a theme (you can change this later).</p>
                            <div class="kfo-row">
                                <div class="kfo-rowLabel">Theme</div>
                                <div class="kfo-rowControl">
                                    <select class="kfo-select" ng-model="config.THEME.activeThemeId" ng-options="t.id as t.name for t in allThemes" ng-change="applyTheme()"></select>
                                </div>
                            </div>
                        </div>

                        <div ng-if="ui.setupStep == 2">
                            <p>Projects are Outlook task folders. We recommend using a dedicated root folder.</p>
                            <div class="kfo-row">
                                <div class="kfo-rowLabel">Root folder</div>
                                <div class="kfo-rowControl">
                                    <input class="kfo-input" type="text" ng-model="config.PROJECTS.rootFolderName" />
                                    <div class="kfo-small">We will create it if it does not exist.</div>
                                </div>
                            </div>
                            <div class="kfo-row">
                                <div class="kfo-rowLabel">Default project</div>
                                <div class="kfo-rowControl">
                                    <div class="kfo-row" style="margin-bottom:8px;">
                                        <label class="kfo-pill" style="margin:0;">
                                            <input type="radio" ng-model="ui.setupProjectMode" value="create" />
                                            Create a new folder
                                        </label>
                                        <label class="kfo-pill" style="margin:0;">
                                            <input type="radio" ng-model="ui.setupProjectMode" value="link" />
                                            Use an existing folder
                                        </label>
                                    </div>

                                    <div ng-if="ui.setupProjectMode == 'create'">
                                        <input class="kfo-input" type="text" ng-model="ui.setupDefaultProjectName" placeholder="General" />
                                        <div class="kfo-small">We will create this project folder under the root.</div>
                                    </div>

                                    <div ng-if="ui.setupProjectMode == 'link'">
                                        <select class="kfo-select" ng-model="ui.setupExistingProjectEntryID" ng-options="f.entryID as f.name for f in availableProjectFolders"></select>
                                        <div class="kfo-small">We will link it as a project (no tasks are moved).</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div ng-if="ui.setupStep == 3">
                            <p>Start with a lane template.</p>
                            <div class="kfo-row">
                                <div class="kfo-rowLabel">Template</div>
                                <div class="kfo-rowControl">
                                    <select class="kfo-select" ng-model="ui.setupLaneTemplate" ng-change="applyLaneTemplate(ui.setupLaneTemplate)">
                                        <option value="personal">Personal Kanban</option>
                                        <option value="gtd">GTD</option>
                                        <option value="scrum">Scrum</option>
                                    </select>
                                </div>
                            </div>
                            <div class="kfo-small">You can add more lanes at any time in Settings.</div>
                        </div>

                        <div ng-if="ui.setupStep == 4">
                            <p>All set. Your data stays in Outlook. No external services are used.</p>
                            <p class="kfo-small">Next: create a few tasks and drag them between lanes.</p>
                            <p class="kfo-small">Disclaimer: this software is provided "AS IS" with no warranty.</p>
                        </div>
                    </div>
                    <div class="kfo-modalFooter">
                        <div>
                            <button class="kfo-btn" type="button" ng-click="prevSetupStep()" ng-disabled="ui.setupStep == 1">Back</button>
                        </div>
                        <div>
                            <button class="kfo-btn" type="button" ng-click="nextSetupStep()" ng-if="ui.setupStep < 4">Next</button>
                            <button class="kfo-btn" type="button" ng-click="finishSetup()" ng-if="ui.setupStep == 4">Finish</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create project modal -->
            <div class="kfo-modalBackdrop" ng-if="ui.showCreateProject">
                <div class="kfo-modal">
                    <div class="kfo-modalHeader">
                        <h3 class="kfo-modalTitle">Create Project</h3>
                        <button class="kfo-iconBtn" type="button" ng-click="ui.showCreateProject = false" aria-label="Close">
                            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                        </button>
                    </div>
                    <div class="kfo-modalBody">
                        <div class="kfo-row">
                            <div class="kfo-rowLabel">Project name</div>
                            <div class="kfo-rowControl">
                                <div class="kfo-row" style="margin-bottom:8px;">
                                    <label class="kfo-pill" style="margin:0;">
                                        <input type="radio" ng-model="ui.createProjectMode" value="create" />
                                        Create a new folder
                                    </label>
                                    <label class="kfo-pill" style="margin:0;">
                                        <input type="radio" ng-model="ui.createProjectMode" value="link" />
                                        Use an existing folder
                                    </label>
                                </div>

                                <div ng-if="ui.createProjectMode == 'create'">
                                    <input class="kfo-input" type="text" ng-model="ui.newProjectName" placeholder="Project name" />
                                    <div class="kfo-small">This creates a Tasks folder under the projects root.</div>
                                </div>

                                <div ng-if="ui.createProjectMode == 'link'">
                                    <select class="kfo-select" ng-model="ui.linkProjectEntryID" ng-options="f.entryID as f.name for f in availableProjectFolders"></select>
                                    <div class="kfo-small">This links an existing folder as a project (no tasks are moved).</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="kfo-modalFooter">
                        <button class="kfo-btn" type="button" ng-click="ui.showCreateProject = false">Cancel</button>
                        <button class="kfo-btn" type="button" ng-click="submitCreateProject()">Save</button>
                    </div>
                </div>
            </div>

            <!-- Diagnostics modal -->
            <div class="kfo-modalBackdrop" ng-if="ui.showDiagnostics">
                <div class="kfo-modal">
                    <div class="kfo-modalHeader">
                        <h3 class="kfo-modalTitle">Diagnostics (Local)</h3>
                        <button class="kfo-iconBtn" type="button" ng-click="ui.showDiagnostics = false" aria-label="Close">
                            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                        </button>
                    </div>
                    <div class="kfo-modalBody">
                        <p class="kfo-small">This is generated locally. Some parts are stored in Outlook (config/state/log). Copy/paste only if you choose to share it.</p>
                        <textarea class="kfo-input" style="height: 260px; width: 100%; border-radius: 14px;" readonly="readonly">{{diagnosticsText}}</textarea>
                    </div>
                    <div class="kfo-modalFooter">
                        <button class="kfo-btn" type="button" ng-click="copyDiagnostics()">Copy</button>
                        <button class="kfo-btn" type="button" ng-click="ui.showDiagnostics = false">Close</button>
                    </div>
                </div>
            </div>

            <!-- Error details modal -->
            <div class="kfo-modalBackdrop" ng-if="ui.showErrorDetails">
                <div class="kfo-modal">
                    <div class="kfo-modalHeader">
                        <h3 class="kfo-modalTitle">Error details (Local)</h3>
                        <button class="kfo-iconBtn" type="button" ng-click="ui.showErrorDetails = false" aria-label="Close">
                            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                        </button>
                    </div>
                    <div class="kfo-modalBody">
                        <p class="kfo-small">This stays local. Use it to understand what happened and to share details only if you choose to.</p>
                        <textarea class="kfo-input" style="height: 260px; width: 100%; border-radius: 14px;" readonly="readonly">{{errorDetailsText}}</textarea>
                    </div>
                    <div class="kfo-modalFooter">
                        <button class="kfo-btn" type="button" ng-click="copyErrorDetails()">Copy</button>
                        <button class="kfo-btn" type="button" ng-click="openDiagnostics(); ui.showErrorDetails = false">Open diagnostics</button>
                        <button class="kfo-btn" type="button" ng-click="clearLastError()">Clear</button>
                        <button class="kfo-btn" type="button" ng-click="ui.showErrorDetails = false">Close</button>
                    </div>
                </div>
            </div>

            <!-- Rename project modal -->
            <div class="kfo-modalBackdrop" ng-if="ui.showRenameProject">
                <div class="kfo-modal">
                    <div class="kfo-modalHeader">
                        <h3 class="kfo-modalTitle">Rename Project</h3>
                        <button class="kfo-iconBtn" type="button" ng-click="ui.showRenameProject = false" aria-label="Close">
                            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                        </button>
                    </div>
                    <div class="kfo-modalBody">
                        <div class="kfo-row">
                            <div class="kfo-rowLabel">New name</div>
                            <div class="kfo-rowControl">
                                <input class="kfo-input" style="width:100%;" type="text" ng-model="ui.renameProjectName" placeholder="Project name" />
                                <div class="kfo-small">This renames the Outlook Tasks folder.</div>
                            </div>
                        </div>
                    </div>
                    <div class="kfo-modalFooter">
                        <button class="kfo-btn" type="button" ng-click="ui.showRenameProject = false">Cancel</button>
                        <button class="kfo-btn" type="button" ng-click="submitRenameProject()">Rename</button>
                    </div>
                </div>
            </div>

            <!-- Move tasks modal -->
            <div class="kfo-modalBackdrop" ng-if="ui.showMoveTasks">
                <div class="kfo-modal">
                    <div class="kfo-modalHeader">
                        <h3 class="kfo-modalTitle">Move Tasks Between Projects</h3>
                        <button class="kfo-iconBtn" type="button" ng-click="closeMoveTasks()" aria-label="Close">
                            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                        </button>
                    </div>
                    <div class="kfo-modalBody">
                        <div class="kfo-row">
                            <div class="kfo-rowLabel">From</div>
                            <div class="kfo-rowControl">
                                <select class="kfo-select" ng-model="ui.move.fromProjectEntryID" ng-options="p.entryID as p.name for p in projectsAll"></select>
                            </div>
                        </div>
                        <div class="kfo-row">
                            <div class="kfo-rowLabel">To</div>
                            <div class="kfo-rowControl">
                                <select class="kfo-select" ng-model="ui.move.toProjectEntryID" ng-options="p.entryID as p.name for p in projectsAll"></select>
                            </div>
                        </div>

                        <div class="kfo-row">
                            <div class="kfo-rowLabel">Selection</div>
                            <div class="kfo-rowControl">
                                <select class="kfo-select" ng-model="ui.move.mode">
                                    <option value="all">All tasks</option>
                                    <option value="lane">Tasks in a lane</option>
                                    <option value="unassigned">Tasks without a lane</option>
                                </select>
                                <select class="kfo-select" ng-model="ui.move.laneId" ng-if="ui.move.mode == 'lane'" ng-options="l.id as l.title for l in laneOptions"></select>
                            </div>
                        </div>

                        <div class="kfo-divider"></div>

                        <div ng-if="ui.move.running">
                            <div class="kfo-small">Moving {{ui.move.progress.done}} / {{ui.move.progress.total}} tasks</div>
                            <div class="kfo-progress" style="margin-top:8px;">
                                <div class="kfo-progressBar" ng-style="{'width': ui.move.progress.percent + '%'}"></div>
                            </div>
                        </div>

                        <div ng-if="!ui.move.running" class="kfo-small">
                            This moves tasks between Outlook folders. Lane metadata is kept on the task.
                        </div>
                    </div>
                    <div class="kfo-modalFooter">
                        <button class="kfo-btn" type="button" ng-click="closeMoveTasks()" ng-disabled="ui.move.running">Cancel</button>
                        <button class="kfo-btn" type="button" ng-click="runMoveTasks()" ng-disabled="ui.move.running">Move</button>
                    </div>
                </div>
            </div>

            <!-- Migration modal -->
            <div class="kfo-modalBackdrop" ng-if="ui.showMigration">
                <div class="kfo-modal">
                    <div class="kfo-modalHeader">
                        <h3 class="kfo-modalTitle">Migrate Lanes (Local)</h3>
                        <button class="kfo-iconBtn" type="button" ng-click="closeMigration()" aria-label="Close">
                            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                        </button>
                    </div>
                    <div class="kfo-modalBody">
                        <p class="kfo-small">Assign lanes based on the existing Outlook Task Status for tasks in the current project.</p>

                        <div class="kfo-row">
                            <div class="kfo-rowLabel">Scope</div>
                            <div class="kfo-rowControl">
                                <label class="kfo-pill" style="margin:0;">
                                    <input type="checkbox" ng-model="ui.migration.onlyUnassigned" />
                                    Only tasks without a lane
                                </label>
                                <label class="kfo-pill" style="margin:0;">
                                    <input type="checkbox" ng-model="ui.migration.treatUnknownAsUnassigned" />
                                    Treat unknown lanes as unassigned
                                </label>
                            </div>
                        </div>

                        <div class="kfo-divider"></div>

                        <div class="kfo-row" ng-repeat="m in ui.migration.mappingRows">
                            <div class="kfo-rowLabel">{{m.statusText}}</div>
                            <div class="kfo-rowControl">
                                <select class="kfo-select" ng-model="m.laneId" ng-options="l.id as l.title for l in migrationLaneOptions">
                                    <option value="">(Skip)</option>
                                </select>
                                <span class="kfo-small">{{m.count}} tasks</span>
                            </div>
                        </div>

                        <div class="kfo-divider"></div>

                        <div ng-if="ui.migration.running">
                            <div class="kfo-small">Migrating {{ui.migration.progress.done}} / {{ui.migration.progress.total}} tasks</div>
                            <div class="kfo-progress" style="margin-top:8px;">
                                <div class="kfo-progressBar" ng-style="{'width': ui.migration.progress.percent + '%'}"></div>
                            </div>
                            <div class="kfo-small" style="margin-top:8px;">Updated: {{ui.migration.progress.updated}} &nbsp;•&nbsp; Skipped: {{ui.migration.progress.skipped}} &nbsp;•&nbsp; Errors: {{ui.migration.progress.errors}}</div>
                        </div>

                        <div ng-if="!ui.migration.running" class="kfo-small">This is local-only and does not move tasks between folders.</div>
                    </div>
                    <div class="kfo-modalFooter">
                        <button class="kfo-btn" type="button" ng-click="closeMigration()" ng-disabled="ui.migration.running">Cancel</button>
                        <button class="kfo-btn" type="button" ng-click="runMigration()" ng-disabled="ui.migration.running">Run</button>
                    </div>
                </div>
            </div>

            <!-- Toasts -->
            <div class="kfo-toastWrap" ng-if="ui.toast.show">
                <div class="kfo-toast" ng-class="'kfo-toast--' + ui.toast.type">
                    <div class="kfo-toastHeader">
                        <div class="kfo-toastTitle">{{ui.toast.title}}</div>
                        <button class="kfo-iconBtn" type="button" ng-click="dismissToast()" aria-label="Dismiss">
                            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                        </button>
                    </div>
                    <div class="kfo-toastMsg" ng-if="ui.toast.message">{{ui.toast.message}}</div>
                </div>
            </div>
        </div>
    </body>

</html>
